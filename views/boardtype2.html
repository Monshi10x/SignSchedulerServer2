<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Two-Column Day Task Board</title>
  <script type="text/javascript" src="../javascript/Sortable/Sortable.js"></script>
  <style>
    :root{
      --bg:#0b0f17;
      --text:#e8eefc;
      --muted:#9fb0d0;
      --line:rgba(255,255,255,.10);
      --line2:rgba(255,255,255,.06);

      --metaW: 320px;
      --actionsW: 140px;

      --taskH: 90px;            /* was 50px */
      --dayHeaderH: 34px;
      --dayFooterH: 28px;

      /* timeline */
      --timelineHeaderH: 44px;
      --slotW: 28px; /* 15-minute slot width */
      --startMin: 360; /* 6:00 */
      --endMin: 1020;  /* 17:00 */
      --timelineW: calc(((var(--endMin) - var(--startMin)) / 15) * var(--slotW)); /* 44 slots */

      /* left color bar */
      --barW: 12px; /* double the old 6px */
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background: radial-gradient(1200px 800px at 30% 10%, #15213a 0%, var(--bg) 60%);
      color:var(--text);
      overflow:hidden;
    }

    .topbar{
      height:56px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:0 14px;
      border-bottom:1px solid var(--line);
      background: linear-gradient(180deg, rgba(16,24,38,.95), rgba(16,24,38,.75));
      backdrop-filter: blur(10px);
      position:sticky;
      top:0;
      z-index:100;
    }
    .brand{ display:flex; gap:10px; align-items:center; font-weight:800; }
    .pill{
      font-size:12px; color:var(--muted);
      padding:4px 8px; border:1px solid var(--line);
      border-radius:999px; background:rgba(255,255,255,.04);
      font-weight:700;
    }
    .actions{ display:flex; gap:8px; align-items:center; }
    button{
      appearance:none; border:1px solid var(--line);
      background: rgba(255,255,255,.05);
      color:var(--text); padding:9px 10px;
      border-radius:10px; cursor:pointer; font-weight:700;
    }
    button:hover{ background: rgba(255,255,255,.08); }
    button:active{ transform: translateY(1px); }

    .board-scroll{
      height: calc(100vh - 56px);
      overflow:auto;
    }

    .board-grid{
      display:grid;
      grid-template-columns: 1fr;
      min-height:100%;
    }

    /* LEFT COLUMN */
    .left-col{
      background: linear-gradient(180deg, rgba(16,24,38,.65), rgba(16,24,38,.35));
      padding:10px 10px 40px;
    }
    .days-grid{
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .days-grid.view-5,
    .days-grid.view-7{
      display:grid;
      gap:10px;
      align-items:start;
    }
    .days-grid.view-5{
      grid-template-columns: repeat(5, minmax(260px, 1fr));
    }
    .days-grid.view-7{
      grid-template-columns: repeat(7, minmax(240px, 1fr));
    }

    .left-header-spacer{
      height: calc(var(--timelineHeaderH) + 19px);
      border:1px solid var(--line);
      border-radius:14px;
      background: rgba(255,255,255,.02);
      margin-bottom:10px;
      position: sticky;
      top: 0;
      z-index: 20;
      backdrop-filter: blur(10px);
      display:grid;
      grid-template-rows: 1fr 15px;
      align-items:center;
      gap:6px;
      padding:6px 12px 8px;
      min-width: 100%;
    }
    .left-header-spacer .hint{
      font-size:12px; color: rgba(159,176,208,.9); font-weight:800;
    }
    .left-header-top{
      display:grid;
      grid-template-columns: var(--metaW) 1fr var(--actionsW);
      align-items:center;
      gap:12px;
    }
    .left-header-actions{
      text-align:right;
    }
    .timeline-header-inline{
      height:100%;
      position:relative;
    }
    .timeline-header-inner{
      width: 100%;
      min-width: 100%;
      height: 100%;
      position:relative;
    }

    .day{
      border:1px solid var(--line);
      border-radius:14px;
      background: rgba(255,255,255,.03);
      margin-bottom:10px;
      overflow:hidden;
      min-height: 120px;
      min-width: 100%;
    }
    .day-header{
      height: var(--dayHeaderH);
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:0 10px;
      border-bottom:1px solid var(--line2);
      background: rgba(255,255,255,.02);
      font-weight:800;
    }
    .day-header .sub{
      font-weight:700; color:var(--muted);
      font-size:12px;
    }

    .tasks{
      padding:8px 8px 0;
      display:flex;
      flex-direction:column;
      gap:8px;
    }

    .task{
      height: var(--taskH);
      border:1px solid var(--line);
      border-radius:12px;
      background: rgba(255,255,255,.035);
      display:flex;
      flex-direction:column;
      gap:4px;
      overflow:hidden;
      position:relative;
      user-select:none;
      padding:0;
    }
    .task.completed{ opacity:.45; filter:saturate(.6); }

    .task-typebar{
      height:10px;
      background: var(--c, #4aa3ff);
      display:flex;
      align-items:center;
      justify-content:flex-start;
      font-size:8px;
      font-weight:900;
      letter-spacing:.4px;
      text-transform:uppercase;
      color: rgba(255,255,255,.95);
      padding-left:5px;
    }
    .task-type-input{
      min-width:20px;
      height:100%;
      border:1px solid rgba(255,255,255,.25);
      border-radius:999px;
      background: rgba(0,0,0,.18);
      color: rgba(255,255,255,.95);
      font-weight:900;
      font-size:8px;
      letter-spacing:.4px;
      text-transform:uppercase;
      padding:0 6px;
      line-height:1;
    }
    .task-type-input:focus{
      outline:none;
      border-color: rgba(255,255,255,.45);
      background: rgba(0,0,0,.3);
    }

    .task .meta{
      display:flex;
      align-items:stretch;
      min-width:0;
    }

    .task-main{
      display:grid;
      grid-template-columns: minmax(160px, 2fr) minmax(0, 1fr) minmax(120px, auto);
      align-items:center;
      gap:12px;
      flex:1;
      min-height:0;
      padding:3px 2px;
    }
    .task .body{
      flex:1;
      display:flex;
      flex-direction:column;
      align-items:flex-start;
      gap:2px;
      padding:0;
      min-width:0;
      justify-content:flex-start;
    }
    .task-desc-input{
      width:auto;
      min-width:20px;
      background: transparent;
      border:1px solid rgba(255,255,255,.18);
      color: var(--text);
      font-weight:800;
      text-align:left;
      font-family: inherit;
      font-size:14px;
      padding:4px 10px;
      border-radius:999px;
      text-overflow: ellipsis;
    }
    .task-customer{
      font-size:8px;
      color: rgba(232,238,252,.55);
      font-weight:700;
      margin-top:2px;
      text-align:left;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width:100%;
    }
    .task-desc-input:focus{
      outline:none;
      border-color: rgba(255,255,255,.25);
      background: rgba(0,0,0,.15);
    }
    .days-grid.view-5 .task-desc-input{
      min-width:120px;
    }
    .days-grid.view-7 .task-desc-input{
      min-width:90px;
    }
    .days-grid:not(.view-5):not(.view-7) .task-desc-input{
      min-width:160px;
    }

    /* task name centered and can be 2 lines with ellipsis on last line */
    .desc{
      flex:1;
      min-width:0;
      font-weight:800;
      text-align:center;

      display:-webkit-box;
      -webkit-box-orient: vertical;
      -webkit-line-clamp: 2;
      overflow:hidden;
      line-height:1.15;
      max-height: calc(1.15em * 2);
    }

    .task .right{
      width: var(--actionsW);
      display:flex;
      align-items:center;
      gap:6px;
      justify-content:flex-end;
    }
    .assignees-card{
      display:flex;
      align-items:center;
      gap:6px;
      justify-content:flex-end;
    }
    .assignees-card{
      display:flex;
      align-items:center;
      gap:6px;
      justify-content:flex-end;
    }
    .assignees-card{
      display:flex;
      align-items:center;
      gap:6px;
      justify-content:flex-end;
    }
    .assignees-card{
      display:flex;
      align-items:center;
      gap:6px;
      justify-content:flex-end;
    }
    .assignees-card{
      display:flex;
      align-items:center;
      gap:6px;
      margin-right:6px;
      flex-wrap:nowrap;
    }
    .iconbtn{
      width:32px; height:32px;
      border-radius:10px;
      display:grid; place-items:center;
      border:1px solid var(--line);
      background: rgba(255,255,255,.05);
      cursor:pointer;
      flex:0 0 auto;
    }
    .iconbtn:hover{ background: rgba(255,255,255,.09); }
    .iconbtn svg{ width:16px; height:16px; }
    .iconbtn.danger{
      border-color: rgba(255,77,77,.35);
      background: rgba(255,77,77,.10);
    }
    .iconbtn.danger:hover{ background: rgba(255,77,77,.18); }

    .completebtn{
      width:34px; height:34px;
      border-radius:12px;
      border:1px solid rgba(140,255,185,.25);
      background: rgba(140,255,185,.12);
      display:grid; place-items:center;
      cursor:pointer;
      flex:0 0 auto;
    }
    .completebtn:hover{ background: rgba(140,255,185,.18); }
    .completebtn svg{ width:18px; height:18px; }

    .task.dragging{
      opacity:.95;
      box-shadow: 0 14px 28px rgba(0,0,0,.35);
      transform: translateY(-2px) scale(1.02);
      z-index:5;
      position:relative;
    }
    .task.placeholder{
      border:0;
      background: transparent;
      opacity:0;
      visibility:hidden;
      box-shadow:none;
    }

    .add-area{
      height: var(--dayFooterH);
      margin:8px;
      border-radius:12px;
      border:1px dashed rgba(255,255,255,.20);
      background: rgba(255,255,255,.02);
      display:flex;
      align-items:center;
      justify-content:center;
      color: rgba(232,238,252,.75);
      font-weight:800;
      cursor:pointer;
    }
    .add-area:hover{ background: rgba(255,255,255,.05); }

    .hours{
      position:absolute;
      inset:0;
      display:block;
    }
    .hours .label{
      position:absolute;
      bottom:6px;
      transform: translateX(-50%);
      font-size:12px;
      font-weight:900;
      color: rgba(232,238,252,.85);
      white-space:nowrap;
      pointer-events:none;
    }

    /* More visible vertical lines: hour (strong) + 15-min (light) */
    .grid-bg{
      position:absolute;
      inset:0;
      background:
        linear-gradient(to right, rgba(255,255,255,.22) 1px, transparent 1px) 0 0 / calc(var(--slotW) * 4) 100%, /* hour */
        linear-gradient(to right, rgba(255,255,255,.10) 1px, transparent 1px) 0 0 / var(--slotW) 100%;          /* 15-min */
      pointer-events:none;
      opacity:1;
    }

    .task-timeline{
      display:flex;
      align-items:flex-end;
      height:15px;
      width:100%;
      margin-top:auto;
    }
    .task-timeline-inner{
      width: 100%;
      min-width: 100%;
      height: 100%;
      position:relative;
      border-radius:10px;
      border:1px solid rgba(255,255,255,.06);
      background: rgba(255,255,255,.015);
      overflow: visible;
    }
    .task.completed .task-timeline-inner{ opacity:.75; }

    /* TIME BAR (right column) â€” square edges (no rounded) */
    .bar{
      position:absolute;
      top:0;
      bottom:0;
      left: var(--left, 0px);
      width: var(--w, 0px);
      border-radius: 0;          /* removed rounded */
      background: #ffffff;
      box-shadow: 0 10px 24px rgba(0,0,0,.25);
      cursor:pointer;
      display:flex;
      align-items:center;
      gap:6px;
      padding:0 10px;
      overflow: visible;          /* IMPORTANT: allow time labels outside */
      z-index:2;
    }

    .bar .handle{
      position:absolute;
      top:50%;
      transform: translateY(-50%);
      width:12px;
      height:16px;
      border-radius:9px;
      background: rgba(255,255,255,.18);
      border:1px solid rgba(255,255,255,.30);
      cursor: ew-resize;
      z-index:5;
    }
    .bar .handle.left{ left:-6px; }
    .bar .handle.right{ right:-6px; }
    .bar .handle::before{
      content:"";
      position:absolute;
      left:50%; top:50%;
      width:2px; height:12px;
      transform: translate(-50%,-50%);
      background: rgba(255,255,255,.65);
      box-shadow: 4px 0 0 rgba(255,255,255,.45), -4px 0 0 rgba(255,255,255,.45);
      border-radius:2px;
      opacity:.8;
    }

    .assignees{
      display:flex;
      gap:6px;
      align-items:center;
      flex:1;
      min-width:0;
      z-index:4;
    }
    .person-chip{
      font-size:11px;
      font-weight:900;
      padding:4px 8px;
      border-radius:999px;
      background: var(--p, rgba(255,255,255,.15));
      border:1px solid rgba(255,255,255,.25);
      white-space:nowrap;
      flex:0 0 auto;
    }
    @media (max-width: 550px){
      .person-chip{
        padding:4px 6px;
        min-width:20px;
        justify-content:center;
      }
      .person-chip span{ display:none; }
      .person-chip::before{
        content: attr(data-initial);
      }
    }

    /* Rotated time labels outside bar, not clipped */
    .time-label{
      position:absolute;
      top:-19px;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:2px 6px;
      min-width:20px;
      background: #101010;
      border:1px solid #0a0a0a;
      border-radius:5px;
      color: rgba(255,255,255,.95);
      font-weight:1000;
      font-size:11px;
      letter-spacing:.2px;
      text-shadow: 0 2px 10px rgba(0,0,0,.55);
      pointer-events:none;
      z-index:6;
      white-space:nowrap;
    }
    .time-label::after{
      content:"";
      position:absolute;
      left:50%;
      bottom:-6px;
      transform: translateX(-50%);
      border-width:6px 5px 0;
      border-style:solid;
      border-color:#101010 transparent transparent;
    }
    .time-label.start{ left: -12px; }
    .time-label.end{ right: -12px; }

    /* MODAL */
    .modal-backdrop{
      position:fixed;
      inset:0;
      background: rgba(0,0,0,.55);
      display:none;
      align-items:center;
      justify-content:center;
      padding:20px;
      z-index:200;
    }
    .modal-backdrop.show{ display:flex; }
    .modal{
      width:min(640px, 100%);
      border-radius:16px;
      border:1px solid var(--line);
      background: linear-gradient(180deg, rgba(16,24,38,.98), rgba(16,24,38,.92));
      box-shadow: 0 30px 80px rgba(0,0,0,.55);
      overflow:hidden;
    }
    .modal-head{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:12px 14px;
      border-bottom:1px solid var(--line);
    }
    .modal-title{ font-weight:900; }
    .modal-body{ padding:14px; display:grid; gap:10px; }
    .row{
      display:grid;
      grid-template-columns: 130px 1fr;
      gap:10px;
      align-items:start;
    }
    .row label{
      font-size:12px;
      color: var(--muted);
      font-weight:900;
      letter-spacing:.2px;
      padding-top:10px;
    }
    input, select{
      width:100%;
      border-radius:12px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.05);
      color: var(--text);
      padding:10px 10px;
      font-weight:700;
      outline:none;
    }
    .assignee-grid{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      padding:10px;
      border-radius:12px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
    }
    .assignee-pill{
      display:flex;
      align-items:center;
      gap:8px;
      border:1px solid var(--line2);
      background: rgba(255,255,255,.04);
      border-radius:999px;
      padding:6px 10px;
      cursor:pointer;
      user-select:none;
      font-weight:900;
      font-size:12px;
    }
    .assignee-pill input{ width:auto; }
    .dot{
      width:10px; height:10px;
      border-radius:999px;
      background: var(--p);
      box-shadow: 0 0 0 2px rgba(0,0,0,.25);
    }

    .modal-foot{
      display:flex;
      gap:8px;
      justify-content:flex-end;
      padding:12px 14px;
      border-top:1px solid var(--line);
    }
    .hint{
      font-size:12px;
      color: rgba(159,176,208,.85);
      line-height:1.35;
    }

    /* SETTINGS POPOVER */
    .settings-panel{
      position:fixed;
      top:64px;
      right:14px;
      width:320px;
      border-radius:16px;
      border:1px solid var(--line);
      background: linear-gradient(180deg, rgba(16,24,38,.98), rgba(16,24,38,.92));
      box-shadow: 0 30px 80px rgba(0,0,0,.55);
      padding:12px;
      display:none;
      z-index:300;
    }
    .settings-panel.show{ display:block; }
    .settings-panel h4{ margin:0 0 10px; font-size:13px; }
    .settings-panel .srow{
      display:grid;
      grid-template-columns: 1fr 90px;
      gap:8px;
      align-items:center;
      margin-bottom:8px;
    }
    .settings-panel .srow span{
      font-size:12px;
      color: var(--muted);
      font-weight:900;
    }

    .tiny{ font-size:11px; color: rgba(159,176,208,.82); }

    @media (max-width: 900px){
      body{ overflow:auto; }
      .board-scroll{ height:auto; overflow:visible; }
      .left-header-spacer{ top:56px; }
    }
    @media (max-width: 520px){
      .task-main{
        grid-template-columns: 1fr;
        gap:6px;
      }
      .task .right{
        justify-content:flex-start;
        flex-wrap:wrap;
      }
    }
  </style>
</head>
<body>
  <div class="topbar">
    <div class="brand">
      <span>Task Board</span>
      <span class="pill">2-column day + timeline</span>
    </div>
    <div class="actions">
      <select id="viewSelect" aria-label="View mode">
        <option value="infinite">Infinite scroll</option>
        <option value="week5">5 days</option>
        <option value="week7">7 days</option>
      </select>
      <button id="btnToday">Jump to Today</button>
      <button id="btnSettings">Settings</button>
    </div>
  </div>

  <div id="settingsPanel" class="settings-panel">
    <h4>Settings</h4>
    <div class="srow">
      <span>Days visible (min height)</span>
      <input id="daysVisibleInput" type="number" min="3" max="14" step="1" />
    </div>
    <div class="tiny">
      Controls the <b>minimum</b> height of each day (days can grow taller with tasks).
    </div>
    <div style="height:10px"></div>
    <button id="btnCloseSettings" style="width:100%;">Close</button>
  </div>

  <div id="boardScroll" class="board-scroll">
    <div class="board-grid">
      <div class="left-col" id="leftCol">
        <div class="left-header-spacer">
          <div class="left-header-top">
            <div class="hint">Days</div>
            <div></div>
            <div class="hint left-header-actions">Actions</div>
          </div>
          <div class="timeline-header-inline">
            <div class="timeline-header-inner">
              <div class="grid-bg"></div>
              <div class="hours" id="timelineHours"></div>
            </div>
          </div>
        </div>
        <div class="days-grid" id="daysGrid"></div>
      </div>
    </div>
  </div>

  <!-- Modal -->
  <div class="modal-backdrop" id="modalBackdrop">
    <div class="modal">
      <div class="modal-head">
        <div class="modal-title" id="modalTitle">Edit Task</div>
        <button id="modalClose">Close</button>
      </div>
      <div class="modal-body">
        <div class="row">
          <label>Task type</label>
          <select id="mType"></select>
        </div>
        <div class="row">
          <label>Description</label>
          <input id="mDesc" type="text" placeholder="Short description"/>
        </div>
        <div class="row">
          <label>Customer</label>
          <input id="mCustomer" type="text" placeholder="Customer name"/>
        </div>
        <div class="row">
          <label>Colour</label>
          <input id="mColor" type="color" />
        </div>
        <div class="row">
          <label>Time from</label>
          <select id="mStart"></select>
        </div>
        <div class="row">
          <label>Time to</label>
          <select id="mEnd"></select>
        </div>
        <div class="row">
          <label>Assignees</label>
          <div class="assignee-grid" id="mAssignees"></div>
        </div>
        <div class="hint">
          Click a timeline bar to edit assignees (and other fields). Drag bar to move time. Drag handles to resize.
        </div>
      </div>
      <div class="modal-foot">
        <button id="modalSave">Save</button>
      </div>
    </div>
  </div>

<script>
(() => {
  const TASK_TYPES = [
    { key: "Design", color: "#4aa3ff" },
    { key: "Print", color: "#ffcc33" },
    { key: "CNC", color: "#22c55e" },
    { key: "Install", color: "#fb7185" },
    { key: "Admin", color: "#a78bfa" },
  ];

  const PEOPLE = [
    { name: "Tristan", color: "#22c55e" },
    { name: "Leandri", color: "#4aa3ff" },
    { name: "Ben", color: "#ffcc33" },
    { name: "Mel", color: "#fb7185" },
    { name: "Anton", color: "#a78bfa" },
  ];

  const START_MIN = 360;
  const END_MIN = 1020;
  const SLOT = 15;
  const DEFAULT_START = 540;
  const DEFAULT_DUR = 60;

  const STORAGE_KEY = "twoColBoard_v4";

  const state = {
    settings: { daysVisible: 5, viewMode: "infinite" },
    tasksByDate: {},
    render: { startDate: null, endDate: null, days: [] },
    modal: { open:false, dateKey:null, taskId:null }
  };

  const boardScroll = document.getElementById('boardScroll');
  const leftCol = document.getElementById('leftCol');
  const daysGrid = document.getElementById('daysGrid');
  const hours = document.getElementById('timelineHours');

  const btnToday = document.getElementById('btnToday');
  const btnSettings = document.getElementById('btnSettings');
  const viewSelect = document.getElementById('viewSelect');

  const settingsPanel = document.getElementById('settingsPanel');
  const daysVisibleInput = document.getElementById('daysVisibleInput');
  const btnCloseSettings = document.getElementById('btnCloseSettings');

  const modalBackdrop = document.getElementById('modalBackdrop');
  const modalClose = document.getElementById('modalClose');
  const modalSave = document.getElementById('modalSave');
  const modalTitle = document.getElementById('modalTitle');

  const mType = document.getElementById('mType');
  const mDesc = document.getElementById('mDesc');
  const mCustomer = document.getElementById('mCustomer');
  const mColor = document.getElementById('mColor');
  const mStart = document.getElementById('mStart');
  const mEnd = document.getElementById('mEnd');
  const mAssignees = document.getElementById('mAssignees');

  const pad2 = (n) => String(n).padStart(2,'0');
  const slotW = () => parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--slotW'));
  function clamp(n,a,b){ return Math.max(a, Math.min(b,n)); }
  function snapToSlot(mins){ return Math.round(mins / SLOT) * SLOT; }

  function toDateKey(d){
    const y=d.getFullYear(), m=pad2(d.getMonth()+1), da=pad2(d.getDate());
    return `${y}-${m}-${da}`;
  }
  function fromDateKey(key){
    const [y,m,d]=key.split('-').map(Number);
    return new Date(y,m-1,d);
  }
  function addDays(date,n){
    const d=new Date(date);
    d.setDate(d.getDate()+n);
    return d;
  }
  function startOfWeek(date){
    const d = new Date(date);
    const day = d.getDay();
    const diff = (day + 6) % 7; // Monday start
    d.setDate(d.getDate() - diff);
    d.setHours(0,0,0,0);
    return d;
  }
  function formatDayHeader(dateKey){
    const d=fromDateKey(dateKey);
    const days=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];
    const months=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
    return `${days[d.getDay()]} ${d.getDate()} ${months[d.getMonth()]}`;
  }

  function minsToLeftPx(mins){
    const delta = mins - START_MIN;
    return (delta / SLOT) * slotW();
  }
  function pxToMins(px){
    const slots = px / slotW();
    return START_MIN + Math.round(slots) * SLOT;
  }
  function minsToLabel(mins){
    const h24=Math.floor(mins/60), m=mins%60;
    const ampm=h24>=12?"pm":"am";
    const h12=((h24+11)%12)+1;
    return `${h12}:${pad2(m)}${ampm}`;
  }
  function ensureTasks(dateKey){
    if(!state.tasksByDate[dateKey]) state.tasksByDate[dateKey]=[];
  }
  function uid(){ return Math.random().toString(16).slice(2) + Math.random().toString(16).slice(2); }
  function getTask(dateKey, taskId){
    const arr=state.tasksByDate[dateKey]||[];
    return arr.find(t=>t.id===taskId)||null;
  }
  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
  }
  function updateTimelineScale(){
    const totalSlots = (END_MIN - START_MIN) / SLOT;
    const taskWidth = daysGrid.querySelector('.task')?.getBoundingClientRect().width
      || Math.max(0, leftCol.getBoundingClientRect().width - 20);
    const slotWidth = Math.max(12, taskWidth / totalSlots);
    document.documentElement.style.setProperty('--slotW', `${slotWidth}px`);
    document.documentElement.style.setProperty('--timelineW', `${slotWidth * totalSlots}px`);
  }

  function load(){
    try{
      const raw=localStorage.getItem(STORAGE_KEY);
      if(!raw) return;
      const parsed=JSON.parse(raw);
      if(parsed?.settings){
        if(parsed.settings.daysVisible) state.settings.daysVisible=parsed.settings.daysVisible;
        if(parsed.settings.viewMode) state.settings.viewMode=parsed.settings.viewMode;
      }
      if(parsed?.tasksByDate && typeof parsed.tasksByDate==='object'){
        state.tasksByDate=parsed.tasksByDate;
      }
    }catch(e){ console.warn("load failed", e); }
  }
  function save(){
    localStorage.setItem(STORAGE_KEY, JSON.stringify({
      settings: state.settings,
      tasksByDate: state.tasksByDate
    }));
  }

  function applySettings(){
    const vis = clamp(parseInt(state.settings.daysVisible,10)||5, 3, 14);
    state.settings.daysVisible=vis;
    daysVisibleInput.value=vis;
    viewSelect.value = state.settings.viewMode || "infinite";
  }

  function renderTimelineHeader(){
    hours.innerHTML = "";
    const totalHours = (END_MIN - START_MIN) / 60;
    for(let i=0;i<=totalHours;i++){
      const mins = START_MIN + i*60;
      const x = minsToLeftPx(mins);
      const lab = document.createElement('div');
      lab.className = 'label';
      lab.style.left = `${x}px`;
      lab.textContent = minsToLabel(mins).replace(":00","");
      hours.appendChild(lab);
    }
  }


  function initRange(){
    const today=new Date();
    const base = startOfWeek(today);
    state.render.startDate = addDays(base, -28);
    state.render.endDate = addDays(base, 28);
    rebuildDaysArray();
  }
  function rebuildDaysArray(){
    const days=[];
    let d=new Date(state.render.startDate);
    const end=state.render.endDate;
    while(d<=end){
      days.push(toDateKey(d));
      d=addDays(d,1);
    }
    state.render.days=days;
  }

  function extendBottom(n=20){
    if(state.settings.viewMode !== "infinite") return;
    const oldEnd = new Date(state.render.endDate);
    state.render.endDate = addDays(oldEnd, n);
    const startCount = state.render.days.length;
    let d = addDays(oldEnd, 1);
    for(let i=0;i<n;i++){
      state.render.days.push(toDateKey(d));
      d = addDays(d,1);
    }
    for(let i=startCount;i<state.render.days.length;i++){
      daysGrid.appendChild(renderLeftDay(state.render.days[i]));
    }
  }

  function extendTop(n=20){
    if(state.settings.viewMode !== "infinite") return;
    const oldStart = new Date(state.render.startDate);
    const newStart = addDays(oldStart, -n);
    state.render.startDate = newStart;

    const newDays=[];
    let d=new Date(newStart);
    for(let i=0;i<n;i++){
      newDays.push(toDateKey(d));
      d=addDays(d,1);
    }

    const firstKey = state.render.days[0];
    const firstEl = document.querySelector(`.day[data-day="${firstKey}"]`);
    const beforeTop = firstEl ? firstEl.getBoundingClientRect().top : null;

    state.render.days = [...newDays, ...state.render.days];

    for(let i=newDays.length-1;i>=0;i--){
      daysGrid.insertBefore(renderLeftDay(newDays[i]), daysGrid.firstChild);
    }

    if(firstEl && beforeTop !== null){
      const afterTop = firstEl.getBoundingClientRect().top;
      boardScroll.scrollTop += (afterTop - beforeTop);
    }
  }

  function addTask(dateKey){
    ensureTasks(dateKey);
    const base = TASK_TYPES[0];
    const t = {
      id: uid(),
      type: base.key,
      color: base.color,
      desc: "New task",
      customer: "",
      startMin: DEFAULT_START,
      durMin: DEFAULT_DUR,
      completed: false,
      assignees: ["Tristan"]
    };
    state.tasksByDate[dateKey].push(t);
    save();
    rerenderDay(dateKey);
  }

  function deleteTask(dateKey, taskId){
    ensureTasks(dateKey);
    state.tasksByDate[dateKey] = (state.tasksByDate[dateKey]||[]).filter(t => t.id !== taskId);
    save();
    rerenderDay(dateKey);
  }

  function toggleComplete(dateKey, taskId){
    const t=getTask(dateKey, taskId);
    if(!t) return;
    t.completed = !t.completed;
    save();
    rerenderDay(dateKey);
  }

  function updateTask(dateKey, taskId, patch){
    const t=getTask(dateKey, taskId);
    if(!t) return;

    Object.assign(t, patch);
    t.startMin = snapToSlot(clamp(t.startMin, START_MIN, END_MIN - SLOT));
    t.durMin = snapToSlot(clamp(t.durMin, SLOT, END_MIN - t.startMin));

    save();
    rerenderDay(dateKey);
  }

  function buildTypeOptions(){
    mType.innerHTML="";
    for(const t of TASK_TYPES){
      const opt=document.createElement('option');
      opt.value=t.key;
      opt.textContent=t.key;
      mType.appendChild(opt);
    }
  }
  function buildTimeOptions(selectEl){
    selectEl.innerHTML="";
    for(let mins=START_MIN; mins<=END_MIN; mins+=SLOT){
      const opt=document.createElement('option');
      opt.value=mins;
      opt.textContent=minsToLabel(mins);
      selectEl.appendChild(opt);
    }
  }
  function buildAssignees(task){
    mAssignees.innerHTML="";
    const selected = new Set(task.assignees || []);
    for(const p of PEOPLE){
      const pill=document.createElement('label');
      pill.className="assignee-pill";
      pill.style.setProperty('--p', p.color);
      pill.innerHTML = `
        <input type="checkbox" ${selected.has(p.name) ? "checked" : ""} data-person="${escapeHtml(p.name)}"/>
        <span class="dot" style="--p:${p.color}"></span>
        <span>${escapeHtml(p.name)}</span>
      `;
      mAssignees.appendChild(pill);
    }
  }

  function openModal(dateKey, taskId, focusAssignees=false){
    const t=getTask(dateKey, taskId);
    if(!t) return;
    state.modal.open=true;
    state.modal.dateKey=dateKey;
    state.modal.taskId=taskId;

    buildTypeOptions();
    buildTimeOptions(mStart);
    buildTimeOptions(mEnd);

    mType.value=t.type;
    mDesc.value=t.desc;
    mCustomer.value=t.customer || "";
    mColor.value=t.color;

    mStart.value=t.startMin;
    const endMin = clamp(t.startMin + t.durMin, START_MIN + SLOT, END_MIN);
    mEnd.value=endMin;

    buildAssignees(t);

    modalTitle.textContent = focusAssignees ? "Edit Assignees" : "Edit Task";
    modalBackdrop.classList.add('show');

    if(focusAssignees){
      // no-op (just helps mentally)
    }
  }
  function closeModal(){
    state.modal.open=false;
    state.modal.dateKey=null;
    state.modal.taskId=null;
    modalBackdrop.classList.remove('show');
  }
  function saveModal(){
    const dateKey=state.modal.dateKey;
    const taskId=state.modal.taskId;
    const t=getTask(dateKey, taskId);
    if(!t) return closeModal();

    const type=mType.value;
    const desc=(mDesc.value||"").trim() || "Task";
    const customer=(mCustomer.value||"").trim();
    const color=mColor.value || t.color;

    const start=parseInt(mStart.value,10);
    const end=parseInt(mEnd.value,10);
    let dur=end-start;
    if(dur < SLOT) dur=SLOT;

    const assignees=[...mAssignees.querySelectorAll('input[type="checkbox"]:checked')]
      .map(x => x.getAttribute('data-person'))
      .filter(Boolean);

    updateTask(dateKey, taskId, { type, desc, customer, color, startMin:start, durMin:dur, assignees: assignees.length ? assignees : [] });
    closeModal();
  }

  modalClose.addEventListener('click', closeModal);
  modalBackdrop.addEventListener('click', (e)=>{ if(e.target===modalBackdrop) closeModal(); });
  modalSave.addEventListener('click', saveModal);

  mStart.addEventListener('change', ()=>{
    const s=parseInt(mStart.value,10);
    let e=parseInt(mEnd.value,10);
    if(e <= s) e = clamp(s + SLOT, START_MIN + SLOT, END_MIN);
    mEnd.value=e;
  });
  mEnd.addEventListener('change', ()=>{
    const s=parseInt(mStart.value,10);
    let e=parseInt(mEnd.value,10);
    if(e <= s) e = clamp(s + SLOT, START_MIN + SLOT, END_MIN);
    mEnd.value=e;
  });

  function clearAll(){
    daysGrid.innerHTML="";
  }

  function renderAll(){
    updateTimelineScale();
    clearAll();
    const mode = state.settings.viewMode || "infinite";
    daysGrid.classList.toggle('view-5', mode === 'week5');
    daysGrid.classList.toggle('view-7', mode === 'week7');
    for(const dayKey of getRenderedDays()){
      daysGrid.appendChild(renderLeftDay(dayKey));
    }
  }

  function rerenderDay(dayKey){
    const left = document.querySelector(`.day[data-day="${dayKey}"]`);
    if(left) left.replaceWith(renderLeftDay(dayKey));
  }

  function getRenderedDays(){
    const mode = state.settings.viewMode || "infinite";
    if(mode === "infinite") return state.render.days;
    const days = [];
    let d = new Date(state.render.startDate);
    const end = new Date(state.render.endDate);
    while(d <= end){
      if(mode === "week7" || (mode === "week5" && d.getDay() !== 0 && d.getDay() !== 6)){
        days.push(toDateKey(d));
      }
      d = addDays(d, 1);
    }
    return days;
  }

  function renderLeftDay(dayKey){
    ensureTasks(dayKey);
    const day=document.createElement('div');
    day.className='day';
    day.dataset.day=dayKey;
    day.id=`day-${dayKey}`;

    const head=document.createElement('div');
    head.className='day-header';
    head.innerHTML=`
      <div>${formatDayHeader(dayKey)}</div>
      <div class="sub">${(state.tasksByDate[dayKey]||[]).length} tasks</div>
    `;
    day.appendChild(head);

    const tasks=document.createElement('div');
    tasks.className='tasks';
    tasks.dataset.tasksFor=dayKey;

    for(const t of (state.tasksByDate[dayKey]||[])){
      tasks.appendChild(renderTaskCard(dayKey, t));
    }
    day.appendChild(tasks);

    const addArea=document.createElement('div');
    addArea.className='add-area';
    addArea.textContent='+ Add task';
    addArea.addEventListener('click', ()=>addTask(dayKey));
    day.appendChild(addArea);

    initSortable(tasks, dayKey);

    return day;
  }

  function renderTaskCard(dayKey, task){
    const el=document.createElement('div');
    el.className='task'+(task.completed?' completed':'');
    el.dataset.taskId=task.id;
    el.dataset.day=dayKey;
    el.style.setProperty('--c', task.color);

    const typeBar=document.createElement('div');
    typeBar.className='task-typebar';
    typeBar.innerHTML = `<input class="task-type-input" value="${escapeHtml(task.type)}" aria-label="Task type" />`;

    const meta=document.createElement('div');
    meta.className='meta';
    const customerName = (task.customer || "").trim();
    meta.innerHTML=`
      <div class="body">
        <input class="task-desc-input" value="${escapeHtml(task.desc)}" aria-label="Task description" />
        ${customerName ? `<div class="task-customer">${escapeHtml(customerName)}</div>` : ""}
      </div>
    `;

    const timeline=document.createElement('div');
    timeline.className='task-timeline';

    const track=document.createElement('div');
    track.className='task-timeline-inner';
    track.innerHTML = `<div class="grid-bg"></div>`;

    const left=minsToLeftPx(task.startMin);
    const w=minsToLeftPx(task.startMin + task.durMin) - left;

    const bar=document.createElement('div');
    bar.className='bar';
    bar.style.setProperty('--c', task.color);
    bar.style.setProperty('--left', `${left}px`);
    bar.style.setProperty('--w', `${Math.max(0,w)}px`);

    const tStart=document.createElement('div');
    tStart.className='time-label start';
    tStart.innerHTML = `<span class="time-label-text">${minsToLabel(task.startMin)}</span>`;

    const tEnd=document.createElement('div');
    tEnd.className='time-label end';
    tEnd.innerHTML = `<span class="time-label-text">${minsToLabel(task.startMin + task.durMin)}</span>`;

    bar.appendChild(tStart);
    bar.appendChild(tEnd);

    const hL=document.createElement('div');
    hL.className='handle left';
    hL.title="Resize start";
    const hR=document.createElement('div');
    hR.className='handle right';
    hR.title="Resize end";
    bar.appendChild(hL);
    bar.appendChild(hR);

    bar.addEventListener('click', (e)=>{
      if(e.target.classList.contains('handle')) return;
      e.stopPropagation();
      openModal(dayKey, task.id, true);
    });

    track.appendChild(bar);
    timeline.appendChild(track);

    const actions=document.createElement('div');
    actions.className='right';

    const assigneesWrap=document.createElement('div');
    assigneesWrap.className='assignees-card';
    const assignees = (task.assignees || []);
    for(const name of assignees){
      const person = PEOPLE.find(p => p.name === name);
      const chip=document.createElement('div');
      chip.className='person-chip';
      chip.style.setProperty('--p', person?.color || 'rgba(255,255,255,.15)');
      chip.dataset.initial = name ? name[0].toUpperCase() : '';
      chip.innerHTML = `<span>${escapeHtml(name)}</span>`;
      assigneesWrap.appendChild(chip);
    }

    actions.innerHTML=`
      <div class="iconbtn" title="Edit">${iconPencil()}</div>
      <div class="iconbtn danger" title="Delete">${iconTrash()}</div>
      <div class="completebtn" title="Complete">${iconCheck()}</div>
    `;

    const main=document.createElement('div');
    main.className='task-main';
    main.appendChild(meta);
    main.appendChild(document.createElement('div'));
    main.appendChild(actions);

    actions.prepend(assigneesWrap);

    el.appendChild(typeBar);
    el.appendChild(main);
    el.appendChild(timeline);

    actions.querySelector('.iconbtn').addEventListener('click', (e)=>{ e.stopPropagation(); openModal(dayKey, task.id); });
    actions.querySelector('.iconbtn.danger').addEventListener('click', (e)=>{ e.stopPropagation(); deleteTask(dayKey, task.id); });
    actions.querySelector('.completebtn').addEventListener('click', (e)=>{ e.stopPropagation(); toggleComplete(dayKey, task.id); });

    const descInput = meta.querySelector('.task-desc-input');
    const updateDescWidth = () => {
      const length = Math.max(2, descInput.value.length + 1);
      descInput.style.width = `${Math.max(20, length * 8)}px`;
    };
    updateDescWidth();
    descInput.addEventListener('pointerdown', (e)=> e.stopPropagation());
    descInput.addEventListener('click', (e)=> e.stopPropagation());
    descInput.addEventListener('input', updateDescWidth);
    descInput.addEventListener('change', () => {
      updateTask(dayKey, task.id, { desc: descInput.value.trim() || "Task" });
    });
    descInput.addEventListener('keydown', (e) => {
      if(e.key === 'Enter'){
        e.preventDefault();
        descInput.blur();
      }
    });

    const typeInput = typeBar.querySelector('.task-type-input');
    const updateTypeWidth = () => {
      const length = Math.max(2, typeInput.value.length + 1);
      typeInput.style.width = `${Math.max(20, length * 7)}px`;
    };
    updateTypeWidth();
    typeInput.addEventListener('click', (e)=> e.stopPropagation());
    typeInput.addEventListener('input', updateTypeWidth);
    typeInput.addEventListener('change', () => {
      updateTask(dayKey, task.id, { type: typeInput.value.trim() || task.type });
    });
    typeInput.addEventListener('keydown', (e)=>{
      if(e.key === 'Enter'){
        e.preventDefault();
        typeInput.blur();
      }
    });

    enableBarDrag(bar, dayKey, task.id);
    enableBarResizeRight(hR, bar, dayKey, task.id);
    enableBarResizeLeft(hL, bar, dayKey, task.id);

    return el;
  }

  function setBarTimes(barEl, startMin, durMin){
    const start = barEl.querySelector('.time-label.start');
    const end = barEl.querySelector('.time-label.end');
    if(start) start.textContent = minsToLabel(startMin);
    if(end) end.textContent = minsToLabel(startMin + durMin);
  }

  function enableBarDrag(barEl, dayKey, taskId){
    let dragging=false, startX=0, startLeftPx=0;

    barEl.addEventListener('pointerdown', (e)=>{
      if(e.target.classList.contains('handle')) return;
      e.preventDefault();
      dragging=true;
      barEl.setPointerCapture(e.pointerId);
      startX=e.clientX;

      const t=getTask(dayKey, taskId);
      if(!t) return;
      startLeftPx = minsToLeftPx(t.startMin);
    });

    barEl.addEventListener('pointermove', (e)=>{
      if(!dragging) return;
      const t=getTask(dayKey, taskId);
      if(!t) return;

      const dx=e.clientX - startX;
      const rawLeft = startLeftPx + dx;
      const rawMins = pxToMins(rawLeft);
      const snapped = snapToSlot(rawMins);

      const maxStart = END_MIN - t.durMin;
      const newStart = clamp(snapped, START_MIN, maxStart);

      barEl.style.setProperty('--left', `${minsToLeftPx(newStart)}px`);
      setBarTimes(barEl, newStart, t.durMin);

    });

    barEl.addEventListener('pointerup', ()=>{
      if(!dragging) return;
      dragging=false;

      const t=getTask(dayKey, taskId);
      if(!t) return;

      const cssLeft = parseFloat(getComputedStyle(barEl).getPropertyValue('--left')) || 0;
      const newStart = snapToSlot(pxToMins(cssLeft));
      const maxStart = END_MIN - t.durMin;
      updateTask(dayKey, taskId, { startMin: clamp(newStart, START_MIN, maxStart) });
    });

    barEl.addEventListener('pointercancel', ()=> dragging=false);
  }

  function enableBarResizeRight(handleEl, barEl, dayKey, taskId){
    let resizing=false, startX=0, startW=0;

    handleEl.addEventListener('pointerdown', (e)=>{
      e.preventDefault(); e.stopPropagation();
      resizing=true;
      handleEl.setPointerCapture(e.pointerId);
      startX=e.clientX;
      startW = parseFloat(getComputedStyle(barEl).getPropertyValue('--w')) || 0;
    });

    handleEl.addEventListener('pointermove', (e)=>{
      if(!resizing) return;
      const t=getTask(dayKey, taskId);
      if(!t) return;

      const dx=e.clientX - startX;
      const rawW = startW + dx;
      const slots = Math.max(1, Math.round(rawW / slotW()));
      let dur = slots * SLOT;
      dur = snapToSlot(clamp(dur, SLOT, END_MIN - t.startMin));

      const left = minsToLeftPx(t.startMin);
      const w = minsToLeftPx(t.startMin + dur) - left;
      barEl.style.setProperty('--w', `${Math.max(0,w)}px`);
      setBarTimes(barEl, t.startMin, dur);
    });

    handleEl.addEventListener('pointerup', ()=>{
      if(!resizing) return;
      resizing=false;

      const t=getTask(dayKey, taskId);
      if(!t) return;

      const wPx = parseFloat(getComputedStyle(barEl).getPropertyValue('--w')) || 0;
      const slots = Math.max(1, Math.round(wPx / slotW()));
      let dur = slots * SLOT;
      dur = snapToSlot(clamp(dur, SLOT, END_MIN - t.startMin));
      updateTask(dayKey, taskId, { durMin: dur });
    });

    handleEl.addEventListener('pointercancel', ()=> resizing=false);
  }

  function enableBarResizeLeft(handleEl, barEl, dayKey, taskId){
    let resizing=false, startX=0, startLeft=0, startEndMin=0;

    handleEl.addEventListener('pointerdown', (e)=>{
      e.preventDefault(); e.stopPropagation();
      resizing=true;
      handleEl.setPointerCapture(e.pointerId);
      startX=e.clientX;

      const t=getTask(dayKey, taskId);
      if(!t) return;

      startLeft = minsToLeftPx(t.startMin);
      startEndMin = t.startMin + t.durMin;
    });

    handleEl.addEventListener('pointermove', (e)=>{
      if(!resizing) return;
      const t=getTask(dayKey, taskId);
      if(!t) return;

      const dx = e.clientX - startX;
      const rawLeft = startLeft + dx;
      let newStart = snapToSlot(pxToMins(rawLeft));

      newStart = clamp(newStart, START_MIN, startEndMin - SLOT);
      const newDur = snapToSlot(clamp(startEndMin - newStart, SLOT, END_MIN - newStart));

      barEl.style.setProperty('--left', `${minsToLeftPx(newStart)}px`);
      barEl.style.setProperty('--w', `${minsToLeftPx(newStart + newDur) - minsToLeftPx(newStart)}px`);
      setBarTimes(barEl, newStart, newDur);

    });

    handleEl.addEventListener('pointerup', ()=>{
      if(!resizing) return;
      resizing=false;

      const cssLeft = parseFloat(getComputedStyle(barEl).getPropertyValue('--left')) || 0;
      let newStart = snapToSlot(pxToMins(cssLeft));
      newStart = clamp(newStart, START_MIN, startEndMin - SLOT);

      const newDur = snapToSlot(clamp(startEndMin - newStart, SLOT, END_MIN - newStart));
      updateTask(dayKey, taskId, { startMin: newStart, durMin: newDur });
    });

    handleEl.addEventListener('pointercancel', ()=> resizing=false);
  }

  function initSortable(tasksContainer, dayKey){
    if(!window.Sortable) return;
    new Sortable(tasksContainer, {
      group: {
        name: 'days',
        pull: true,
        put: true
      },
      animation: 150,
      delay: 300,
      delayOnTouchOnly: true,
      touchStartThreshold: 4,
      handle: '.task-main, .task-typebar',
      filter: '.iconbtn, .completebtn, .bar, .handle, .task-desc-input, .task-type-input',
      onMove: (evt) => {
        if(evt.originalEvent?.target?.closest('.bar, .handle')) return false;
        return true;
      },
      onAdd: (evt) => {
        const fromDay = evt.from?.dataset?.tasksFor;
        const toDay = evt.to?.dataset?.tasksFor;
        const taskId = evt.item?.dataset?.taskId;
        if(!fromDay || !toDay || !taskId) return;

        const fromTasks = state.tasksByDate[fromDay] || [];
        const toTasks = state.tasksByDate[toDay] || [];
        const taskIndex = fromTasks.findIndex(t => t.id === taskId);
        if(taskIndex < 0) return;
        const [task] = fromTasks.splice(taskIndex, 1);
        toTasks.splice(evt.newIndex, 0, task);
        state.tasksByDate[fromDay] = fromTasks;
        state.tasksByDate[toDay] = toTasks;
        save();
      },
      onEnd: () => {
        const ids=[...tasksContainer.querySelectorAll('.task')].map(el=>el.dataset.taskId);
        const current=state.tasksByDate[dayKey]||[];
        const byId=new Map(current.map(t=>[t.id,t]));
        state.tasksByDate[dayKey]=ids.map(id=>byId.get(id)).filter(Boolean);
        save();
      }
    });
  }

  function handleInfiniteScroll(){
    const top=boardScroll.scrollTop;
    const height=boardScroll.scrollHeight;
    const view=boardScroll.clientHeight;
    if(top + view > height - 800) extendBottom(20);
    if(top < 300) extendTop(20);
  }

  function jumpToToday(){
    const key=toDateKey(new Date());
    const el=document.getElementById(`day-${key}`);
    if(el) el.scrollIntoView({block:'start', behavior:'smooth'});
  }

  btnSettings.addEventListener('click', ()=>{
    settingsPanel.classList.toggle('show');
    daysVisibleInput.focus();
  });
  btnCloseSettings.addEventListener('click', ()=> settingsPanel.classList.remove('show'));
  daysVisibleInput.addEventListener('change', ()=>{
    state.settings.daysVisible = clamp(parseInt(daysVisibleInput.value,10)||5,3,14);
    save();
    applySettings();
  });
  viewSelect.addEventListener('change', ()=>{
    state.settings.viewMode = viewSelect.value;
    save();
    applySettings();
    updateTimelineScale();
    renderTimelineHeader();
    renderAll();
  });
  btnToday.addEventListener('click', jumpToToday);

  function iconCheck(){
    return `<svg viewBox="0 0 24 24" fill="none">
      <path d="M20 7L10.5 16.5L4 10" stroke="currentColor" stroke-width="2.4" stroke-linecap="round" stroke-linejoin="round"/>
    </svg>`;
  }
  function iconTrash(){
    return `<svg viewBox="0 0 24 24" fill="none">
      <path d="M3 6h18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
      <path d="M8 6V4h8v2" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
      <path d="M6 6l1 16h10l1-16" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
      <path d="M10 11v6M14 11v6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
    </svg>`;
  }
  function iconPencil(){
    return `<svg viewBox="0 0 24 24" fill="none">
      <path d="M12 20h9" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
      <path d="M16.5 3.5a2.1 2.1 0 0 1 3 3L8 18l-4 1 1-4 11.5-11.5Z" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
    </svg>`;
  }
  function init(){
    load();
    applySettings();
    updateTimelineScale();
    renderTimelineHeader();

    initRange();
    renderAll();

    boardScroll.addEventListener('scroll', handleInfiniteScroll, {passive:true});
    window.addEventListener('resize', ()=>{
      updateTimelineScale();
      renderTimelineHeader();
      renderAll();
    });

    requestAnimationFrame(() => jumpToToday());
  }

  init();
})();
</script>
</body>
</html>
